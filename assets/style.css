// =============================
// Mockrise Blogger Admin Panel
// Updated Version ‚úÖ (Admin Lock + Blogger Publish)
// =============================

// ‚úÖ CONFIG (‡§§‡•Å‡§Æ‡•ç‡§π‡§æ‡§∞‡•Ä details)
const CONFIG = {
  BLOGGER_ID: "1505425628593992085",
  BLOGGER_KEY: "AIzaSyCpBV7mDpohv2rcqjchBil9TsZuV5VNQIk",
  CLIENT_ID: "294178060526-p8n98a97f69l3fa2dfap0md4phud16jp.apps.googleusercontent.com",

  ADMIN_EMAIL: "aadityaraj7852@gmail.com",

  // ‚úÖ IMPORTANT: Email + profile + blogger write permission
  SCOPE: "openid email profile https://www.googleapis.com/auth/blogger",

  DEFAULT_LABELS_SHORTCUTS: [
    "Test",
    "Video Lecture",
    "PDF",
    "Daily Quiz",
    "Cutoff",
    "OMR Checking",
    "Result Name"
  ]
};

const $ = (id) => document.getElementById(id);

// UI
const statusTxt = $("statusTxt");
const labelsBox = $("labelsBox");
const postsBox = $("postsBox");
const activeLabelPill = $("activeLabelPill");
const postsCountPill = $("postsCountPill");

// User
const userName = $("userName");
const userEmail = $("userEmail");
const userPic = $("userPic");

// Buttons
const loginBtn = $("loginBtn");
const logoutBtn = $("logoutBtn");
const refreshBtn = $("refreshBtn");
const publishBtn = $("publishBtn");
const autoJsonBtn = $("autoJsonBtn");
const clearBtn = $("clearBtn");
const addLabelBtn = $("addLabelBtn");

// Inputs
const newLabelInput = $("newLabelInput");
const postTitle = $("postTitle");
const postType = $("postType");
const postContent = $("postContent");
const pdfLink = $("pdfLink");
const videoLink = $("videoLink");

// State
let accessToken = null;
let loggedUser = null;
let activeLabel = null;
let labelShortcuts = [...CONFIG.DEFAULT_LABELS_SHORTCUTS];

function setStatus(text, type = "ok") {
  statusTxt.textContent = text;
  statusTxt.style.color =
    type === "ok" ? "#16a34a" : type === "warn" ? "#f59e0b" : "#dc2626";
}

function escapeHtml(str = "") {
  return String(str)
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;");
}

function makePostHtml({ type, text, pdf, video }) {
  const chips = [];
  if (type) chips.push(`‚úÖ Type: ${type}`);
  if (pdf) chips.push(`üìÑ PDF: ${pdf}`);
  if (video) chips.push(`üé• Video: ${video}`);

  const chipLine = chips.length
    ? `<p><b>${escapeHtml(chips.join(" | "))}</b></p>`
    : "";

  const safeText = escapeHtml(text || "");

  return `
    <div style="font-family:Lexend,Arial;line-height:1.6;">
      ${chipLine}
      <pre style="white-space:pre-wrap;background:#f5f5f8;border:1px solid #e9e9f2;padding:12px;border-radius:14px;font-weight:800;">${safeText}</pre>
    </div>
  `;
}

// -----------------------------
// ‚úÖ Google OAuth Token (GIS)
// -----------------------------
let tokenClient = null;

function initTokenClient() {
  tokenClient = google.accounts.oauth2.initTokenClient({
    client_id: CONFIG.CLIENT_ID,
    scope: CONFIG.SCOPE,
    callback: async (resp) => {
      try {
        if (resp && resp.access_token) {
          accessToken = resp.access_token;
          setStatus("Token ‡§Æ‡§ø‡§≤‡§æ ‚úÖ User verify ‡§π‡•ã ‡§∞‡§π‡§æ...", "warn");
          await afterLoginLoad();
        } else {
          setStatus("Token failed ‚ùå", "err");
          alert("‚ùå Login token ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ");
        }
      } catch (e) {
        console.log(e);
        setStatus("Login error ‚ùå", "err");
      }
    }
  });
}

async function requestToken() {
  if (!tokenClient) initTokenClient();
  tokenClient.requestAccessToken({ prompt: "consent" });
}

// ‚úÖ ‡§∏‡§¨‡§∏‡•á reliable userinfo endpoint
async function fetchUserInfo() {
  const res = await fetch("https://openidconnect.googleapis.com/v1/userinfo", {
    headers: { Authorization: `Bearer ${accessToken}` }
  });
  return await res.json();
}

function normalizeEmail(e) {
  return String(e || "").toLowerCase().trim();
}

function lockAdmin(user) {
  const email = normalizeEmail(user?.email);
  const allowed = normalizeEmail(CONFIG.ADMIN_EMAIL);

  // ‡§Ö‡§ó‡§∞ email ‡§π‡•Ä ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡•Ä ‡§§‡•ã ‡§≠‡•Ä deny
  if (!email) {
    setStatus("Email not found ‚ùå", "err");
    alert("‚ùå Google ‡§∏‡•á email ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡•Ä (scope issue)");
    throw new Error("Email missing");
  }

  if (email !== allowed) {
    setStatus("Access denied ‚ùå", "err");
    alert("‚ùå Access Denied! ‡§Ø‡•á Admin panel ‡§∏‡§ø‡§∞‡•ç‡§´ owner ‡§ï‡•á ‡§≤‡§ø‡§è ‡§π‡•à.");
    throw new Error("Not admin");
  }
}

// -----------------------------
// ‚úÖ Blogger API Helpers
// -----------------------------
function bloggerUrl(path, params = {}) {
  const url = new URL(`https://www.googleapis.com/blogger/v3/${path}`);
  url.searchParams.set("key", CONFIG.BLOGGER_KEY);
  Object.entries(params).forEach(([k, v]) => {
    if (v !== undefined && v !== null && v !== "") url.searchParams.set(k, v);
  });
  return url.toString();
}

async function apiGET(path, params = {}) {
  const url = bloggerUrl(path, params);
  const res = await fetch(url, {
    headers: accessToken ? { Authorization: `Bearer ${accessToken}` } : {}
  });
  return await res.json();
}

async function apiPOST(path, bodyObj) {
  const url = bloggerUrl(path);
  const res = await fetch(url, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      Authorization: `Bearer ${accessToken}`
    },
    body: JSON.stringify(bodyObj)
  });
  return await res.json();
}

async function apiDELETE(path) {
  const url = bloggerUrl(path);
  const res = await fetch(url, {
    method: "DELETE",
    headers: { Authorization: `Bearer ${accessToken}` }
  });

  if (res.status === 204) return { ok: true };

  try {
    return await res.json();
  } catch (e) {
    return { ok: res.ok };
  }
}

// -----------------------------
// ‚úÖ UI Render
// -----------------------------
function renderUser() {
  userName.textContent = loggedUser?.name || "Not logged in";
  userEmail.textContent = loggedUser?.email || "‚Äî";
  userPic.src = loggedUser?.picture || "https://i.ibb.co/2FsfXqM/user.png";
}

function renderLabels() {
  labelsBox.innerHTML = "";

  const all = [...new Set(labelShortcuts)].filter(Boolean);

  if (!all.length) {
    labelsBox.innerHTML = `<div class="mutedSmall">No labels</div>`;
    return;
  }

  all.forEach((lb) => {
    const btn = document.createElement("button");
    btn.className = "labelBtn" + (activeLabel === lb ? " labelBtnActive" : "");
    btn.innerHTML = `
      <span style="display:flex;gap:10px;align-items:center;min-width:0;">
        <span class="material-symbols-outlined" style="color:#0a0ac2;">sell</span>
        <span style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${escapeHtml(
          lb
        )}</span>
      </span>
      <span class="badge">Open</span>
    `;
    btn.onclick = async () => {
      activeLabel = lb;
      activeLabelPill.textContent = `Label: ${lb}`;
      renderLabels();
      await loadPostsByLabel(lb);
    };
    labelsBox.appendChild(btn);
  });
}

// -----------------------------
// ‚úÖ Load Blogger Labels + Posts
// -----------------------------
async function loadLabelsFromBlogger() {
  const data = await apiGET(`blogs/${CONFIG.BLOGGER_ID}/posts/labels`, {});
  const items = data.items || [];

  // merge + unique
  labelShortcuts = [...new Set([...items, ...labelShortcuts])];

  if (!activeLabel && labelShortcuts.length) {
    activeLabel = labelShortcuts[0];
    activeLabelPill.textContent = `Label: ${activeLabel}`;
  }

  renderLabels();
}

async function loadPostsByLabel(label) {
  try {
    setStatus("Posts loading...", "warn");
    postsBox.innerHTML = `<div class="mutedSmall">Loading‚Ä¶</div>`;

    const data = await apiGET(`blogs/${CONFIG.BLOGGER_ID}/posts`, {
      labels: label,
      maxResults: 20,
      fields: "items(id,title,published,updated,labels,url)"
    });

    const items = data.items || [];
    postsCountPill.textContent = `${items.length} posts`;

    if (!items.length) {
      postsBox.innerHTML = `<div class="mutedSmall">No posts in <b>${escapeHtml(
        label
      )}</b>.</div>`;
      setStatus("No posts", "warn");
      return;
    }

    postsBox.innerHTML = "";
    items.forEach((p) => {
      const div = document.createElement("div");
      div.className = "postItem";
      div.innerHTML = `
        <div style="min-width:0;">
          <div class="postTitle">${escapeHtml(p.title || "-")}</div>
          <div class="postMeta">
            Updated: ${escapeHtml(
              new Date(p.updated || p.published || Date.now()).toLocaleString(
                "en-IN"
              )
            )}
          </div>
          <div class="postMeta">
            <a href="${escapeHtml(p.url || "#")}" target="_blank" style="color:#0a0ac2;font-weight:900;">Open Post</a>
          </div>
        </div>
        <div class="postActions">
          <button class="btnDanger">
            <span class="material-symbols-outlined">delete</span>
            Delete
          </button>
        </div>
      `;

      div.querySelector(".btnDanger").onclick = async () => {
        const ok = confirm("Delete this post? ‚ùå");
        if (!ok) return;
        await deletePost(p.id);
        await loadPostsByLabel(activeLabel);
      };

      postsBox.appendChild(div);
    });

    setStatus("Posts loaded ‚úÖ", "ok");
  } catch (e) {
    console.log(e);
    setStatus("Load failed ‚ùå", "err");
    postsBox.innerHTML = `<div class="mutedSmall">Failed to load posts.</div>`;
  }
}

async function deletePost(postId) {
  if (!accessToken) {
    alert("Login first ‚úÖ");
    return;
  }

  setStatus("Deleting...", "warn");

  const data = await apiDELETE(`blogs/${CONFIG.BLOGGER_ID}/posts/${postId}`);

  if (data?.ok || data?.error === undefined) {
    setStatus("Deleted ‚úÖ", "ok");
  } else {
    console.log(data);
    setStatus("Delete failed ‚ùå", "err");
    alert("Delete error ‚ùå (permissions/scope check)");
  }
}

// -----------------------------
// ‚úÖ Publish Post
// -----------------------------
function autoTemplate() {
  const t = postType.value;
  const base = {
    type: t,
    title: postTitle.value || "Mockrise Post",
    time: new Date().toISOString(),
    links: {
      pdf: pdfLink.value || "",
      video: videoLink.value || ""
    }
  };

  postContent.value = `{
  "type": "${base.type}",
  "title": "${base.title}",
  "createdAt": "${base.time}",
  "pdf": "${base.links.pdf}",
  "video": "${base.links.video}",
  "data": {
    "note": "Yaha apna JSON add karo"
  }
}`;
}

function clearForm() {
  postTitle.value = "";
  postContent.value = "";
  pdfLink.value = "";
  videoLink.value = "";
  postType.value = "TEXT";
}

async function publishPost() {
  if (!accessToken) {
    alert("‡§™‡§π‡§≤‡•á Google Login ‡§ï‡§∞‡•ã ‚úÖ");
    return;
  }

  if (!activeLabel) {
    alert("‡§™‡§π‡§≤‡•á label select ‡§ï‡§∞‡•ã ‚úÖ");
    return;
  }

  const title = postTitle.value.trim();
  if (!title) {
    alert("Title required ‚ùå");
    return;
  }

  setStatus("Publishing...", "warn");

  const html = makePostHtml({
    type: postType.value,
    text: postContent.value,
    pdf: pdfLink.value.trim(),
    video: videoLink.value.trim()
  });

  const body = {
    kind: "blogger#post",
    blog: { id: CONFIG.BLOGGER_ID },
    title,
    content: html,
    labels: [activeLabel, postType.value]
  };

  const resp = await apiPOST(`blogs/${CONFIG.BLOGGER_ID}/posts/`, body);

  if (resp?.id) {
    setStatus("Published ‚úÖ", "ok");
    clearForm();
    await loadLabelsFromBlogger();
    await loadPostsByLabel(activeLabel);
    alert("‚úÖ Post Published Successfully!");
  } else {
    console.log(resp);
    setStatus("Publish failed ‚ùå", "err");
    alert("‚ùå Publish Failed!\n\nScope / Consent Screen check ‡§ï‡§∞‡•§");
  }
}

// -----------------------------
// ‚úÖ After Login Load
// -----------------------------
async function afterLoginLoad() {
  try {
    if (!accessToken) {
      setStatus("Token missing ‚ùå", "err");
      return;
    }

    setStatus("Fetching user...", "warn");
    const user = await fetchUserInfo();

    loggedUser = user;
    renderUser();

    // ‚úÖ Admin lock check
    lockAdmin(user);

    setStatus("Loading labels...", "warn");
    await loadLabelsFromBlogger();

    if (activeLabel) {
      await loadPostsByLabel(activeLabel);
    } else {
      postsBox.innerHTML = `<div class="mutedSmall">Select a label</div>`;
    }

    setStatus("Ready ‚úÖ", "ok");
  } catch (e) {
    console.log(e);
    setStatus("Access denied ‚ùå", "err");
  }
}

// -----------------------------
// ‚úÖ Events
// -----------------------------
loginBtn.onclick = async () => {
  try {
    setStatus("Opening Google login...", "warn");
    await requestToken();
  } catch (e) {
    console.log(e);
    setStatus("Login failed ‚ùå", "err");
  }
};

logoutBtn.onclick = () => {
  accessToken = null;
  loggedUser = null;
  activeLabel = null;

  renderUser();
  labelsBox.innerHTML = `<div class="mutedSmall">Logged out ‚úÖ</div>`;
  postsBox.innerHTML = `<div class="mutedSmall">Logged out ‚úÖ</div>`;
  activeLabelPill.textContent = `Label: ‚Äî`;
  postsCountPill.textContent = `0 posts`;
  setStatus("Logged out ‚úÖ", "ok");
};

refreshBtn.onclick = async () => {
  if (!accessToken) {
    alert("Login first ‚úÖ");
    return;
  }
  await afterLoginLoad();
};

publishBtn.onclick = publishPost;
autoJsonBtn.onclick = autoTemplate;
clearBtn.onclick = clearForm;

addLabelBtn.onclick = () => {
  const lb = newLabelInput.value.trim();
  if (!lb) return;

  if (!labelShortcuts.includes(lb)) {
    labelShortcuts.unshift(lb);
  }
  newLabelInput.value = "";

  if (!activeLabel) {
    activeLabel = lb;
    activeLabelPill.textContent = `Label: ${activeLabel}`;
  }

  renderLabels();
  setStatus("Label shortcut added ‚úÖ", "ok");
};

// Init
setStatus("Ready (Login to continue)", "warn");
renderUser();
labelsBox.innerHTML = `<div class="mutedSmall">Login ‡§ï‡§∞‡§ï‡•á labels load ‡§π‡•ã‡§Ç‡§ó‡•á‚Ä¶</div>`;
postsBox.innerHTML = `<div class="mutedSmall">Login ‡§ï‡§∞‡§ï‡•á posts ‡§¶‡§ø‡§ñ‡•á‡§Ç‡§ó‡•á‚Ä¶</div>`;
